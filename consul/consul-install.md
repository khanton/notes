# Настраиваем consul.
Consul удобная штука. Особенно в большом кластере. Я описал все этапы первичной настройки.
## Перед началом.
Мы создадим кластер из трех серверов. Я взял их в Coogle Coud (ubuntu 16.04). Нам понадобятся самые маленькие машины которые только доступны, сonsul потребляет удивительно мало ресурсов. 
Этот кластер станет основой в который можно будет добавлять новые агенты и сервера.
### Пакеты.
Удивительно но hashi corp не собирает пакеты предлагает скачивать или бинарь (даже без конфигов) или zip файлы. Однако Andrea Bernardo Ciddio собрал пакеты для consul и положил их в ppa. Спасибо ему за это.
## Начало
Все дальнейшие действия выполняем на всех машинах кластера.
Первое что делаем обновляем все:
```
sudo apt-get update
sudo apt-get upgrade -y
```
Далее добавляем нужные ppa и устанавливаем consul.
```
sudo apt-add-repository ppa:bcandrea/consul
sudo apt-get update
sudo apt-get install consul
```
Далее создаем директорию для данных. Почему Андрюха ее сразу не создал - загадка.
```
sudo mkdir -p /var/lib/consul
sudo chown consul.consul /var/lib/consul
```
В принципе настройка закончилась теперь надо собрать кластер.
## Собираем кластер
Чтобы собрать кластер в consul надо для начала запустить один узел в режиме bootstrap. Далее подключить к нему все узлы. 
Затем выключить первый узел и подключить его заново уже в режиме обычного сервера. 
Хосты, чтобы не запутатся, у меня называются cons1c, cons1d, cons1b. Bootstrap будем делать на cons1c.
Редактируем файл /etc/default/consul в переменную CONSUL_FLAGS добавляем '-server -bootstrap'. 
```
CONSUL_FLAGS='-server -bootstrap'
```
Это будет наш bootstrap сервер стартуем его:
```
sudo service consul start
```
В syslog наблюдаем загрузку сервера. Он сам себя выбирает лидером кластера. 
Готовим машинки cons1b и cons1d. 
Редактируем файл /etc/default/consul в переменную CONSUL_FLAGS добавляем '-server'. 
```
CONSUL_FLAGS='-server'
```  
Стартуем:
```
sudo service consul start
```
Естественно проверьте в syslog, что все стартовало.
Далее присоеденяем узлы к кластеру для этого делаем:
```
consul join cons1c
```
В syslog на всех машинах должны быть сообщения о присоеденении кластера. Они выглядет вот так:
```
Aug 14 09:10:42 ubuntu consul[19826]:     2016/08/14 12:10:42 [INFO] raft: Added peer 10.132.0.19:8300, starting replication
Aug 14 09:10:42 ubuntu consul[19826]: raft: Added peer 10.132.0.19:8300, starting replication
```
Кластер наш собран и работает. Можно посмотреть его статус командой consul members. Будет чтото типа:
```
ubuntu@cons1c:/var/log$ consul members
Node    Address           Status  Type    Build  Protocol  DC
cons1b  10.132.0.20:8301  alive   server  0.6.4  2         dc1
cons1c  10.132.0.18:8301  alive   server  0.6.4  2         dc1
cons1d  10.132.0.19:8301  alive   server  0.6.4  2         dc1
```
Теперь сама последняя операция надо вывести cons1c из режима bootstrap.
Редактируем файл /etc/default/consul из переменной CONSUL_FLAGS удалем ключ -bootstrap. 
```
CONSUL_FLAGS='-server'
```  
Далее выводим сервер из кластера:
```
consul leave
```
Должно появится сообщение о том, что кластер покинут. В syslog на других машинах через несколько секунд начнется перевыбор лидера и какая то другая машинка станет лидером.
После этого стартуем сервер заново:
````
sudo service consul start
````
и пресоеденяем его к кластеру:
```
consul join cons1b cons1d
``` 
Все кластер собран. Можно убедится в этом командой consul members. В логах должны быть лиш редкие уведомления о репликациях.
## Если чтото пошло не так ?
Документация на www.consul.io. Довольно понятно. На Англиском естественно. Сообщения об ошибках у консула тоже вполне ясные.
У меня были проблемы с правами на директори, где консул хранит свои данные. Основная проблема была с выводим сервера из кластера.
